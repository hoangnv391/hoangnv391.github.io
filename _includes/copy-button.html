<script>
// Add Copy buttons to code blocks — attach floating buttons to document.body so they're not blocked by inner scroll
document.addEventListener('DOMContentLoaded', function () {
  var blocks = document.querySelectorAll('div.highlight, pre');
  var buttons = [];

  function createButton(block) {
    // Skip <pre> that live inside a .highlight (avoid double buttons)
    if (block.tagName && block.tagName.toLowerCase() === 'pre' && block.closest('.highlight')) return;
    // Avoid duplicates
    if (block.dataset && block.dataset.copyBtn) return;

    var btn = document.createElement('button');
    btn.className = 'copy-btn copy-btn-floating';
    btn.type = 'button';
    btn.setAttribute('aria-label', 'Copy code');
    btn.textContent = 'Copy';

    var code = block.querySelector('code') || block.querySelector('pre') || block;

    btn.addEventListener('click', function () {
      var text = code.textContent;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function () {
          btn.textContent = 'Copied!';
          setTimeout(function () { btn.textContent = 'Copy'; }, 1500);
        }).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }

      function fallbackCopy() {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          btn.textContent = 'Copied!';
          setTimeout(function () { btn.textContent = 'Copy'; }, 1500);
        } catch (e) {
          btn.textContent = 'Failed';
          setTimeout(function () { btn.textContent = 'Copy'; }, 1500);
        }
        document.body.removeChild(textarea);
      }
    });

    // add to body and track
    document.body.appendChild(btn);
    buttons.push({btn: btn, block: block});
    if (block.dataset) block.dataset.copyBtn = '1';
  }

  blocks.forEach(createButton);

  function positionButtons() {
    buttons.forEach(function (item) {
      var btn = item.btn, block = item.block;
      var rect = block.getBoundingClientRect();

      // hide button if block is fully out of viewport vertically
      if (rect.bottom < 0 || rect.top > (window.innerHeight || document.documentElement.clientHeight)) {
        btn.style.display = 'none';
        return;
      }

      btn.style.display = '';
      // compute page coordinates (account for scroll)
      var left = rect.right + window.pageXOffset - btn.offsetWidth - 8;
      var top = rect.top + window.pageYOffset + 8;
      btn.style.position = 'absolute';
      btn.style.left = left + 'px';
      btn.style.top = top + 'px';
      btn.style.zIndex = 9999;
    });
  }

  // initial positioning
  positionButtons();
  // reposition on scroll/resize — use capture to catch scrolling in inner elements
  window.addEventListener('scroll', positionButtons, true);
  window.addEventListener('resize', positionButtons);

  // Recompute positions after images/fonts load
  window.addEventListener('load', positionButtons);
});
</script>