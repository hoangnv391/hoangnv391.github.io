<script>
// Add Copy buttons to code blocks â€” insert button inside each container to keep layout stable
document.addEventListener('DOMContentLoaded', function () {
  var blocks = document.querySelectorAll('div.highlight, pre');

  blocks.forEach(function (block) {
    // Skip <pre> that live inside a .highlight (we'll add button to the .highlight container)
    if (block.tagName && block.tagName.toLowerCase() === 'pre' && block.closest('.highlight')) return;

    // Prefer using the .highlight container when available
    var container = (block.tagName && block.tagName.toLowerCase() === 'pre') ? (block.closest('.highlight') || block) : block;

    // Avoid adding duplicates
    if (container.querySelector('.copy-btn')) return;

    // Find code element
    var code = container.querySelector('code') || container.querySelector('pre') || container;
    var combinedClass = (code.className || '') + ' ' + (container.className || '');

    // If class explicitly marks bash-like language, allow
    var isBashClass = /\b(?:language-|lang-)?(?:bash|sh|shell|zsh)\b/i.test(combinedClass);
    var isConsoleClass = /\bconsole\b/i.test(combinedClass);

    // If not explicitly marked, use content heuristic to detect shell commands
    if (!isBashClass) {
      var text = (code.textContent || '').trim();
      var lines = text.split(/\r?\n/).map(function(l){ return l.replace(/\u00A0/g, ' ').trim(); }).filter(function(l){ return l.length > 0; });
      if (lines.length === 0) return; // empty

      // Lines that look like commands (start with prompt $ or #, or look like a command name)
      var cmdLines = lines.filter(function(l){ return /^\s*(?:\$|#|[A-Za-z0-9._-]+@|>)/.test(l) || /^[A-Za-z0-9_\-]+(\s|$|\.)/.test(l); });
      var outputLines = lines.length - cmdLines.length;

      // require at least one command-like line, and not dominated by output (heuristic)
      if (cmdLines.length === 0) return;
      if (outputLines > cmdLines.length * 2) return;

      // also skip if class explicitly says console
      if (isConsoleClass) return;
    }

    // Ensure positioning context
    if (getComputedStyle(container).position === 'static') {
      container.style.position = 'relative';
    }

    var btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.type = 'button';
    btn.setAttribute('aria-label', 'Copy code');
    btn.textContent = 'Copy';

    btn.addEventListener('click', function (e) {
      e.preventDefault();
      var text = code.textContent;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function () {
          btn.textContent = 'Copied!';
          setTimeout(function () { btn.textContent = 'Copy'; }, 1500);
        }).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }

      function fallbackCopy() {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          btn.textContent = 'Copied!';
          setTimeout(function () { btn.textContent = 'Copy'; }, 1500);
        } catch (err) {
          btn.textContent = 'Failed';
          setTimeout(function () { btn.textContent = 'Copy'; }, 1500);
        }
        document.body.removeChild(textarea);
      }
    });

    // Insert button as first child so CSS can position it inside the container
    container.insertBefore(btn, container.firstChild);
  });
});
</script>